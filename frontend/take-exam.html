<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Exam | ExamPro</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Orbitron:wght@500;700&display=swap" rel="stylesheet">
  <style>
    *, *::before, *::after { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: 'Inter', system-ui, -apple-system, sans-serif; font-size: 14px; line-height: 1.5; color: #1e293b; background: #f8fafc; min-height: 100vh; }
    body::before { content: ''; position: fixed; inset: 0; z-index: -2; background: radial-gradient(ellipse at 20% 50%, rgba(79,70,229,0.04) 0%, transparent 50%), radial-gradient(ellipse at 80% 50%, rgba(124,58,237,0.03) 0%, transparent 50%); }
    
    .header { background: rgba(255,255,255,0.95); border-bottom: 1px solid rgba(0,0,0,0.06); color: #1e293b; padding: 16px 24px; display: flex; align-items: center; justify-content: space-between; position: sticky; top: 0; z-index: 100; backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px); }
    .header-title { font-family: 'Orbitron', sans-serif; font-size: 16px; font-weight: 500; background: linear-gradient(135deg, #4f46e5, #7c3aed); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; }
    .timer { display: flex; align-items: center; gap: 8px; background: rgba(79,70,229,0.06); border: 1px solid rgba(79,70,229,0.12); padding: 8px 16px; border-radius: 8px; font-weight: 600; font-size: 18px; font-family: 'Orbitron', monospace; color: #4f46e5; text-shadow: none; }
    .timer.warning { background: rgba(217,119,6,0.08); border-color: rgba(217,119,6,0.2); color: #d97706; text-shadow: none; }
    .timer.danger { background: rgba(220,38,38,0.08); border-color: rgba(220,38,38,0.2); color: #dc2626; text-shadow: none; animation: pulse 1s infinite; }
    @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.7; } }
    
    .container { max-width: 900px; margin: 0 auto; padding: 24px; }
    
    .progress { background: rgba(79,70,229,0.08); height: 6px; border-radius: 3px; margin-bottom: 24px; overflow: hidden; }
    .progress-bar { height: 100%; background: linear-gradient(90deg, #4f46e5, #7c3aed); box-shadow: none; transition: width 0.3s; }
    
    .question-card { background: #ffffff; border: 1px solid #e2e8f0; border-radius: 16px; box-shadow: 0 1px 3px rgba(0,0,0,0.06), 0 4px 16px rgba(0,0,0,0.04); padding: 28px; margin-bottom: 24px; }
    .question-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; }
    .question-num { font-size: 13px; color: #64748b; font-weight: 500; }
    .question-marks { font-size: 13px; color: #4f46e5; font-weight: 600; }
    .question-text { font-size: 16px; font-weight: 500; color: #1e293b; margin-bottom: 20px; }
    
    .options { display: flex; flex-direction: column; gap: 10px; }
    .option { display: flex; align-items: center; gap: 12px; padding: 14px 16px; border: 1px solid #e2e8f0; border-radius: 10px; cursor: pointer; transition: border-color 0.15s, background 0.15s; background: #f8fafc; }
    .option:hover { border-color: rgba(79,70,229,0.4); background: rgba(79,70,229,0.04); }
    .option.selected { border-color: #4f46e5; background: rgba(79,70,229,0.06); box-shadow: 0 0 12px rgba(79,70,229,0.08); }
    .option-letter { width: 28px; height: 28px; border-radius: 50%; background: #e2e8f0; display: flex; align-items: center; justify-content: center; font-weight: 600; font-size: 13px; color: #64748b; flex-shrink: 0; }
    .option.selected .option-letter { background: linear-gradient(135deg, #4f46e5, #7c3aed); color: #ffffff; }
    .option-text { flex: 1; color: #334155; }
    
    .nav { display: flex; justify-content: space-between; align-items: center; gap: 16px; }
    .nav-buttons { display: flex; gap: 12px; }
    .btn { padding: 10px 20px; font-size: 14px; font-weight: 500; border-radius: 8px; border: none; cursor: pointer; transition: background 0.15s, transform 0.15s; font-family: 'Inter', sans-serif; }
    .btn:disabled { opacity: 0.4; cursor: not-allowed; }
    .btn-secondary { background: #f1f5f9; color: #334155; border: 1px solid #d1d5db; }
    .btn-secondary:hover:not(:disabled) { background: #e2e8f0; }
    .btn-primary { background: linear-gradient(135deg, #4f46e5, #4338ca); color: #ffffff; font-weight: 600; }
    .btn-primary:hover:not(:disabled) { box-shadow: 0 4px 14px rgba(79,70,229,0.25); transform: translateY(-1px); }
    .btn-success { background: linear-gradient(135deg, #059669, #10b981); color: #fff; font-weight: 600; }
    .btn-success:hover:not(:disabled) { box-shadow: 0 4px 14px rgba(5,150,105,0.25); transform: translateY(-1px); }
    
    .question-nav { display: flex; flex-wrap: wrap; gap: 8px; }
    .q-btn { width: 36px; height: 36px; border-radius: 8px; border: 1px solid #d1d5db; background: #f1f5f9; cursor: pointer; font-weight: 500; font-size: 13px; color: #64748b; transition: border-color 0.15s, background 0.15s; }
    .q-btn:hover { border-color: rgba(79,70,229,0.4); }
    .q-btn.current { background: linear-gradient(135deg, #4f46e5, #7c3aed); color: #ffffff; border-color: transparent; font-weight: 700; }
    .q-btn.answered { background: rgba(5,150,105,0.08); border-color: rgba(5,150,105,0.25); color: #059669; }
    
    .loading { display: flex; align-items: center; justify-content: center; min-height: 400px; color: #64748b; }
    .spinner { width: 40px; height: 40px; border: 3px solid rgba(79,70,229,0.12); border-top-color: #4f46e5; border-radius: 50%; animation: spin 0.8s linear infinite; }
    @keyframes spin { to { transform: rotate(360deg); } }
    
    .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.35); backdrop-filter: blur(8px); -webkit-backdrop-filter: blur(8px); display: none; align-items: center; justify-content: center; z-index: 1000; }
    .modal-overlay.active { display: flex; }
    .modal { background: #ffffff; border: 1px solid rgba(0,0,0,0.08); border-radius: 16px; padding: 32px; max-width: 400px; text-align: center; box-shadow: 0 16px 48px rgba(0,0,0,0.12); }
    .modal h2 { margin-bottom: 12px; color: #1e293b; font-family: 'Orbitron', sans-serif; font-size: 20px; }
    .modal p { color: #64748b; margin-bottom: 20px; }
    .modal-buttons { display: flex; gap: 12px; justify-content: center; }
    
    /* Real-time features */
    .header-right { display: flex; align-items: center; gap: 16px; }
    .connection-status { font-size: 10px; padding: 4px 10px; border-radius: 12px; font-weight: 500; }
    .connection-status.connected { background: rgba(5,150,105,0.08); color: #059669; border: 1px solid rgba(5,150,105,0.2); }
    .connection-status.saving { background: rgba(217,119,6,0.08); color: #d97706; border: 1px solid rgba(217,119,6,0.2); }
    .connection-status.offline { background: rgba(220,38,38,0.08); color: #dc2626; border: 1px solid rgba(220,38,38,0.2); animation: blink 1s infinite; }
    @keyframes blink { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
    
    .tab-warning { position: fixed; top: 60px; left: 50%; transform: translateX(-50%); background: rgba(217,119,6,0.06); border: 1px solid rgba(217,119,6,0.2); color: #d97706; padding: 12px 24px; border-radius: 8px; font-weight: 500; z-index: 200; display: none; animation: slideDown 0.3s; backdrop-filter: blur(8px); }
    .tab-warning.show { display: block; }
    @keyframes slideDown { from { top: 40px; opacity: 0; } to { top: 60px; opacity: 1; } }
    
    .violation-count { font-size: 11px; color: #dc2626; background: rgba(220,38,38,0.08); border: 1px solid rgba(220,38,38,0.2); padding: 2px 8px; border-radius: 10px; margin-left: 8px; -webkit-text-fill-color: #dc2626; }
    
    /* Scrollbar */
    ::-webkit-scrollbar { width: 6px; }
    ::-webkit-scrollbar-track { background: transparent; }
    ::-webkit-scrollbar-thumb { background: rgba(79,70,229,0.15); border-radius: 3px; }
    ::-webkit-scrollbar-thumb:hover { background: rgba(79,70,229,0.25); }

    /* ===== Theme Toggle ===== */
    .theme-toggle-exam {
      position: fixed;
      top: 14px;
      right: 24px;
      z-index: 150;
      width: 38px;
      height: 38px;
      border-radius: 50%;
      border: 1px solid rgba(0,0,0,0.08);
      background: rgba(255,255,255,0.9);
      backdrop-filter: blur(8px);
      -webkit-backdrop-filter: blur(8px);
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 18px;
      line-height: 1;
      transition: background 0.15s, border-color 0.15s, transform 0.15s;
    }
    .theme-toggle-exam:hover {
      background: rgba(79,70,229,0.08);
      border-color: rgba(79,70,229,0.2);
      transform: scale(1.08);
    }

    /* ===== Dark Theme ===== */
    body.dark { background: #0f172a; color: #e2e8f0; }
    body.dark::before { background: radial-gradient(ellipse at 20% 50%, rgba(99,102,241,0.06) 0%, transparent 50%), radial-gradient(ellipse at 80% 50%, rgba(167,139,250,0.06) 0%, transparent 50%); }
    body.dark .header { background: rgba(30,41,59,0.95); border-bottom-color: rgba(99,102,241,0.1); color: #fff; }
    body.dark .header-title { background: linear-gradient(135deg, #6366f1, #a78bfa); -webkit-background-clip: text; background-clip: text; }
    body.dark .timer { background: rgba(99,102,241,0.08); border-color: rgba(99,102,241,0.15); color: #6366f1; text-shadow: 0 0 20px rgba(99,102,241,0.4); }
    body.dark .timer.warning { background: rgba(251,191,36,0.15); border-color: rgba(251,191,36,0.3); color: #fbbf24; text-shadow: 0 0 20px rgba(251,191,36,0.4); }
    body.dark .timer.danger { background: rgba(239,68,68,0.15); border-color: rgba(239,68,68,0.3); color: #ef4444; text-shadow: 0 0 20px rgba(239,68,68,0.5); }
    body.dark .progress { background: rgba(99,102,241,0.06); }
    body.dark .progress-bar { background: linear-gradient(90deg, #6366f1, #a78bfa); box-shadow: 0 0 12px rgba(99,102,241,0.4); }
    body.dark .question-card { background: rgba(30,41,59,0.92); border-color: rgba(255,255,255,0.06); box-shadow: 0 8px 32px rgba(0,0,0,0.3); }
    body.dark .question-num { color: #94a3b8; }
    body.dark .question-marks { color: #6366f1; }
    body.dark .question-text { color: #f1f5f9; }
    body.dark .option { background: rgba(255,255,255,0.02); border-color: rgba(255,255,255,0.08); }
    body.dark .option:hover { border-color: rgba(99,102,241,0.3); background: rgba(99,102,241,0.04); }
    body.dark .option.selected { border-color: #6366f1; background: rgba(99,102,241,0.08); box-shadow: 0 0 20px rgba(99,102,241,0.1); }
    body.dark .option-letter { background: rgba(255,255,255,0.06); color: #94a3b8; }
    body.dark .option.selected .option-letter { background: linear-gradient(135deg, #6366f1, #a78bfa); color: #0f172a; }
    body.dark .option-text { color: #e2e8f0; }
    body.dark .btn-secondary { background: rgba(255,255,255,0.06); color: #e2e8f0; border-color: rgba(255,255,255,0.1); }
    body.dark .btn-secondary:hover:not(:disabled) { background: rgba(255,255,255,0.1); }
    body.dark .btn-primary { background: linear-gradient(135deg, #6366f1, #4f46e5); color: #ffffff; }
    body.dark .btn-success { background: linear-gradient(135deg, #10b981, #059669); color: #fff; }
    body.dark .q-btn { background: rgba(255,255,255,0.03); border-color: rgba(255,255,255,0.08); color: #94a3b8; }
    body.dark .q-btn:hover { border-color: rgba(99,102,241,0.3); }
    body.dark .q-btn.current { background: linear-gradient(135deg, #6366f1, #a78bfa); color: #0f172a; border-color: transparent; }
    body.dark .q-btn.answered { background: rgba(16,185,129,0.15); border-color: rgba(16,185,129,0.3); color: #10b981; }
    body.dark .modal-overlay { background: rgba(3,7,18,0.8); }
    body.dark .modal { background: rgba(30,41,59,0.95); border-color: rgba(99,102,241,0.15); box-shadow: 0 25px 60px rgba(0,0,0,0.5); }
    body.dark .modal h2 { color: #f1f5f9; }
    body.dark .modal p { color: #94a3b8; }
    body.dark .connection-status.connected { background: rgba(16,185,129,0.15); color: #10b981; border-color: rgba(16,185,129,0.3); }
    body.dark .connection-status.saving { background: rgba(251,191,36,0.15); color: #fbbf24; border-color: rgba(251,191,36,0.3); }
    body.dark .connection-status.offline { background: rgba(239,68,68,0.15); color: #ef4444; border-color: rgba(239,68,68,0.3); }
    body.dark .tab-warning { background: rgba(251,191,36,0.12); border-color: rgba(251,191,36,0.3); color: #fbbf24; }
    body.dark .violation-count { color: #ef4444; background: rgba(239,68,68,0.15); border-color: rgba(239,68,68,0.3); -webkit-text-fill-color: #ef4444; }
    body.dark .theme-toggle-exam { border-color: rgba(255,255,255,0.1); background: rgba(255,255,255,0.06); }
    body.dark .theme-toggle-exam:hover { background: rgba(99,102,241,0.12); border-color: rgba(99,102,241,0.25); }
    body.dark ::-webkit-scrollbar-thumb { background: rgba(99,102,241,0.2); }
    body.dark ::-webkit-scrollbar-thumb:hover { background: rgba(99,102,241,0.35); }

    /* ===== Responsive - Tablet ===== */
    @media (max-width: 768px) {
      .header { padding: 12px 16px; flex-wrap: wrap; gap: 8px; }
      .header-title { font-size: 13px; order: 1; flex: 1; min-width: 0; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
      .header-right { order: 2; gap: 8px; }
      .timer { padding: 6px 12px; font-size: 15px; }
      .connection-status { font-size: 9px; padding: 3px 8px; }
      .theme-toggle-exam { position: static; order: 3; width: 34px; height: 34px; font-size: 16px; }
      .container { padding: 16px; }
      .question-card { padding: 20px; border-radius: 12px; }
      .question-text { font-size: 15px; }
      .option { padding: 12px 14px; }
      .nav { flex-direction: column; gap: 16px; }
      .question-nav { order: 2; justify-content: center; }
      .nav-buttons { order: 1; width: 100%; justify-content: space-between; }
      .q-btn { width: 34px; height: 34px; font-size: 12px; }
      .btn { padding: 10px 16px; font-size: 13px; }
      .nav-buttons .btn { flex: 1; }
      .modal { max-width: 95%; padding: 24px; }
      .tab-warning { font-size: 13px; padding: 10px 16px; left: 16px; right: 16px; transform: none; width: auto; }
    }

    /* ===== Responsive - Mobile ===== */
    @media (max-width: 480px) {
      .header { padding: 10px 12px; }
      .header-title { font-size: 12px; }
      .timer { padding: 5px 10px; font-size: 13px; }
      .container { padding: 12px; }
      .question-card { padding: 16px; margin-bottom: 16px; }
      .question-text { font-size: 14px; }
      .question-header { flex-direction: column; gap: 4px; }
      .option { padding: 10px 12px; gap: 10px; }
      .option-letter { width: 24px; height: 24px; font-size: 11px; }
      .option-text { font-size: 13px; }
      .q-btn { width: 30px; height: 30px; font-size: 11px; border-radius: 6px; }
      .question-nav { gap: 5px; }
      .nav-buttons { flex-direction: column; }
      .nav-buttons .btn { width: 100%; }
      .progress { height: 4px; margin-bottom: 16px; }
    }
  </style>
</head>
<body>
  <header class="header">
    <div class="header-title" id="exam-title">Loading...<span id="violation-badge" class="violation-count" style="display:none;">0 tab switches</span></div>
    <div class="header-right">
      <span id="connection-status" class="connection-status connected">‚óè Connected</span>
      <div class="timer" id="timer">--:--</div>
      <button class="theme-toggle-exam" id="examThemeToggle" title="Toggle theme">‚òÄÔ∏è</button>
    </div>
  </header>
  
  <div id="tab-warning" class="tab-warning">‚ö†Ô∏è Tab switch detected! This activity is being monitored.</div>
  
  <div class="container">
    <div class="progress">
      <div class="progress-bar" id="progress-bar" style="width: 0%"></div>
    </div>
    
    <div id="question-container">
      <div class="loading"><div class="spinner"></div></div>
    </div>
    
    <div class="nav">
      <div class="question-nav" id="question-nav"></div>
      <div class="nav-buttons">
        <button class="btn btn-secondary" id="prev-btn" onclick="prevQuestion()">Previous</button>
        <button class="btn btn-primary" id="next-btn" onclick="nextQuestion()">Next</button>
        <button class="btn btn-success" id="submit-btn" onclick="confirmSubmit()">Submit</button>
      </div>
    </div>
  </div>
  
  <!-- Submit Modal -->
  <div class="modal-overlay" id="submit-modal">
    <div class="modal">
      <h2>Submit Exam?</h2>
      <p id="submit-info">You have answered X of Y questions.</p>
      <div class="modal-buttons">
        <button class="btn btn-secondary" onclick="closeModal()">Cancel</button>
        <button class="btn btn-success" onclick="submitExam()">Submit</button>
      </div>
    </div>
  </div>
  
  <script>
    const API = '/api/v1';
    const TOKEN_KEY = 'exampro-token';
    
    // Check auth (including token expiry)
    const token = localStorage.getItem(TOKEN_KEY);
    if (!token) window.location.href = '/login.html';
    try {
      const p = JSON.parse(atob(token.split('.')[1]));
      if (Date.now() >= p.exp * 1000) { localStorage.removeItem(TOKEN_KEY); window.location.href = '/login.html'; }
    } catch { localStorage.removeItem(TOKEN_KEY); window.location.href = '/login.html'; }
    
    // Theme toggle for exam page
    (function initExamTheme() {
      const theme = localStorage.getItem('exampro-theme');
      if (theme === 'dark') document.body.classList.add('dark');
      const btn = document.getElementById('examThemeToggle');
      if (btn) {
        btn.textContent = theme === 'dark' ? 'üåô' : '‚òÄÔ∏è';
        btn.addEventListener('click', () => {
          document.body.classList.toggle('dark');
          const isDark = document.body.classList.contains('dark');
          localStorage.setItem('exampro-theme', isDark ? 'dark' : 'light');
          btn.textContent = isDark ? 'üåô' : '‚òÄÔ∏è';
        });
      }
    })();
    
    // Get exam ID
    const params = new URLSearchParams(window.location.search);
    const examId = params.get('exam_id');
    if (!examId) window.location.href = '/student-dashboard.html';
    
    let session = null;
    let questions = [];
    let answers = {};
    let currentIndex = 0;
    let timerInterval = null;
    let endTime = null;
    let tabSwitchCount = 0;
    let isOnline = true;
    
    // Tab visibility change detection
    document.addEventListener('visibilitychange', () => {
      if (document.hidden) {
        tabSwitchCount++;
        updateViolationBadge();
        showTabWarning();
        logViolation('tab_switch');
      }
    });
    
    // Window focus detection
    window.addEventListener('blur', () => {
      if (session && !document.hidden) {
        tabSwitchCount++;
        updateViolationBadge();
        showTabWarning();
        logViolation('focus_lost');
      }
    });
    
    function updateViolationBadge() {
      const badge = document.getElementById('violation-badge');
      if (tabSwitchCount > 0) {
        badge.textContent = `${tabSwitchCount} tab switch${tabSwitchCount > 1 ? 'es' : ''}`;
        badge.style.display = 'inline';
      }
    }
    
    function showTabWarning() {
      const warning = document.getElementById('tab-warning');
      warning.classList.add('show');
      setTimeout(() => warning.classList.remove('show'), 3000);
    }
    
    async function logViolation(type) {
      try {
        if (session) {
          await api('POST', `/exam-session/${examId}/violation`, { type, timestamp: new Date().toISOString() });
        }
      } catch (e) { console.log('Violation log failed (endpoint may not exist)'); }
    }
    
    // Connection status management
    function setConnectionStatus(status) {
      const el = document.getElementById('connection-status');
      el.className = 'connection-status ' + status;
      el.textContent = status === 'connected' ? '‚óè Connected' : status === 'saving' ? '‚óè Saving...' : '‚óè Offline';
      isOnline = status !== 'offline';
    }
    
    window.addEventListener('online', () => setConnectionStatus('connected'));
    window.addEventListener('offline', () => setConnectionStatus('offline'));
    
    async function api(method, url, data = null) {
      const headers = { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` };
      const config = { method, headers };
      if (data) config.body = JSON.stringify(data);
      const res = await fetch(`${API}${url}`, config);
      if (res.status === 401) { localStorage.removeItem(TOKEN_KEY); window.location.href = '/login.html'; }
      if (!res.ok) { const err = await res.json().catch(() => ({})); throw new Error(err.detail || 'Request failed'); }
      return res.headers.get('content-type')?.includes('json') ? res.json() : {};
    }
    
    async function init() {
      try {
        // Start or resume session
        session = await api('POST', `/exam-session/${examId}/start`);
        
        const title = session.exam_title || 'Exam';
        document.getElementById('exam-title').innerHTML = `${title}<span id="violation-badge" class="violation-count" style="display:none;">0 tab switches</span>`;
        
        // Load questions
        questions = session.questions || [];
        
        // Load previous answers
        if (session.answers) {
          session.answers.forEach(a => { answers[a.question_id] = a.selected_answer; });
        }
        
        // Set timer from remaining seconds
        const remainingSeconds = session.time_remaining_seconds ?? (20 * 60);
        endTime = new Date(Date.now() + remainingSeconds * 1000);
        startTimer();
        
        // Render
        renderQuestionNav();
        renderQuestion();
        
      } catch (err) {
        const msg = err.message || 'Something went wrong';
        document.getElementById('exam-title').innerHTML = 'Exam Unavailable';
        document.getElementById('timer').style.display = 'none';
        document.getElementById('connection-status').style.display = 'none';
        document.querySelector('.nav').style.display = 'none';
        document.querySelector('.progress').style.display = 'none';
        document.getElementById('question-container').innerHTML = `
          <div style="text-align:center;padding:60px 20px;">
            <div style="font-size:48px;margin-bottom:16px;">‚ö†Ô∏è</div>
            <h2 style="color:#ef4444;margin-bottom:12px;font-family:'Orbitron',sans-serif;text-shadow:0 0 20px rgba(239,68,68,0.3);">${msg}</h2>
            <p style="color:#94a3b8;margin-bottom:24px;">This exam may have ended, or you have already used all your attempts.</p>
            <a href="/student-dashboard.html" class="btn btn-primary" style="text-decoration:none;display:inline-block;">‚Üê Back to Dashboard</a>
          </div>`;
      }
    }
    
    function startTimer() {
      updateTimer();
      timerInterval = setInterval(updateTimer, 1000);
    }
    
    function updateTimer() {
      const now = new Date();
      const remaining = Math.max(0, Math.floor((endTime - now) / 1000));
      
      const mins = Math.floor(remaining / 60);
      const secs = remaining % 60;
      
      const timerEl = document.getElementById('timer');
      timerEl.textContent = `${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
      
      timerEl.classList.remove('warning', 'danger');
      if (remaining <= 60) timerEl.classList.add('danger');
      else if (remaining <= 300) timerEl.classList.add('warning');
      
      if (remaining <= 0) {
        clearInterval(timerInterval);
        submitExam();
      }
    }
    
    function renderQuestionNav() {
      const nav = document.getElementById('question-nav');
      nav.innerHTML = questions.map((q, i) => `
        <button class="q-btn ${i === currentIndex ? 'current' : ''} ${answers[q.question_id] ? 'answered' : ''}" onclick="goToQuestion(${i})">
          ${i + 1}
        </button>
      `).join('');
    }
    
    function renderQuestion() {
      if (questions.length === 0) {
        document.getElementById('question-container').innerHTML = '<div class="loading">No questions available</div>';
        return;
      }
      
      const q = questions[currentIndex];
      const selectedAnswer = answers[q.question_id] || null;
      
      document.getElementById('question-container').innerHTML = `
        <div class="question-card">
          <div class="question-header">
            <span class="question-num">Question ${currentIndex + 1} of ${questions.length}</span>
            <span class="question-marks">${q.marks || 1} mark${q.marks > 1 ? 's' : ''}</span>
          </div>
          <div class="question-text">${q.question_text}</div>
          <div class="options">
            ${(['A', 'B', 'C', 'D']).map(letter => {
              const optText = (typeof q.options === 'object' && !Array.isArray(q.options)) 
                ? q.options[letter] 
                : (Array.isArray(q.options) ? q.options[['A','B','C','D'].indexOf(letter)] : '');
              if (!optText) return '';
              const isSelected = selectedAnswer === letter;
              return `
                <div class="option ${isSelected ? 'selected' : ''}" onclick="selectOption('${letter}')">
                  <div class="option-letter">${letter}</div>
                  <div class="option-text">${optText}</div>
                </div>
              `;
            }).join('')}
          </div>
        </div>
      `;
      
      // Update progress
      const answered = Object.keys(answers).length;
      document.getElementById('progress-bar').style.width = `${(answered / questions.length) * 100}%`;
      
      // Update nav buttons
      document.getElementById('prev-btn').disabled = currentIndex === 0;
      document.getElementById('next-btn').style.display = currentIndex === questions.length - 1 ? 'none' : 'block';
      document.getElementById('submit-btn').style.display = currentIndex === questions.length - 1 ? 'block' : 'none';
      
      renderQuestionNav();
    }
    
    async function selectOption(letter) {
      const q = questions[currentIndex];
      answers[q.question_id] = letter;
      
      // Save to server with connection status
      setConnectionStatus('saving');
      try {
        await api('POST', `/exam-session/${examId}/answer`, {
          question_id: q.question_id,
          selected_answer: letter
        });
        setConnectionStatus('connected');
      } catch (err) {
        console.error('Failed to save answer:', err);
        setConnectionStatus('offline');
      }
      
      renderQuestion();
    }
    
    function prevQuestion() {
      if (currentIndex > 0) {
        currentIndex--;
        renderQuestion();
      }
    }
    
    function nextQuestion() {
      if (currentIndex < questions.length - 1) {
        currentIndex++;
        renderQuestion();
      }
    }
    
    function goToQuestion(index) {
      currentIndex = index;
      renderQuestion();
    }
    
    function confirmSubmit() {
      const answered = Object.keys(answers).length;
      document.getElementById('submit-info').textContent = `You have answered ${answered} of ${questions.length} questions.`;
      document.getElementById('submit-modal').classList.add('active');
    }
    
    function closeModal() {
      document.getElementById('submit-modal').classList.remove('active');
    }
    
    async function submitExam() {
      closeModal();
      clearInterval(timerInterval);
      
      document.getElementById('question-container').innerHTML = '<div class="loading"><div class="spinner"></div></div>';
      
      try {
        const result = await api('POST', `/exam-session/${examId}/submit`);
        
        // Show result
        document.getElementById('question-container').innerHTML = `
          <div class="question-card" style="text-align:center;">
            <h2 style="margin-bottom:16px;color:#f1f5f9;font-family:'Orbitron',sans-serif;">Exam Submitted!</h2>
            <p style="font-size:48px;font-weight:700;color:${result.is_passed ? '#10b981' : '#ef4444'};margin-bottom:8px;text-shadow:0 0 30px ${result.is_passed ? 'rgba(16,185,129,0.5)' : 'rgba(239,68,68,0.5)'};">
              ${result.marks_obtained}/${result.total_marks}
            </p>
            <p style="color:#94a3b8;margin-bottom:24px;">
              ${result.is_passed ? 'üéâ Congratulations! You passed!' : 'Keep practicing!'}
            </p>
            <a href="/student-dashboard.html" class="btn btn-primary" style="text-decoration:none;display:inline-block;">
              Back to Dashboard
            </a>
          </div>
        `;
        
        document.querySelector('.nav').style.display = 'none';
        
      } catch (err) {
        document.getElementById('question-container').innerHTML = `
          <div style="text-align:center;padding:40px 20px;">
            <div style="font-size:36px;margin-bottom:12px;">‚ùå</div>
            <h2 style="color:#ef4444;margin-bottom:12px;font-family:'Orbitron',sans-serif;">${err.message || 'Submission failed'}</h2>
            <p style="color:#94a3b8;margin-bottom:20px;">Please try again or contact your instructor.</p>
            <a href="/student-dashboard.html" class="btn btn-primary" style="text-decoration:none;display:inline-block;">‚Üê Back to Dashboard</a>
          </div>`;
      }
    }
    
    init();
  </script>
</body>
</html>
