<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Question Banks | ExamPro Admin</title>
  <link rel="stylesheet" href="/css/app.css">
  <style>
    /* ===== Bank Cards ===== */
    .bank-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
      gap: 20px;
    }
    .bank-card {
      background: var(--glass-bg-solid);
      border-radius: var(--radius-lg);
      box-shadow: var(--shadow-card);
      padding: 0;
      cursor: pointer;
      transition: box-shadow 0.2s, transform 0.2s, border-color 0.2s;
      border: 1px solid var(--glass-border);
      overflow: hidden;
      position: relative;
    }
    .bank-card::before {
      content: '';
      position: absolute;
      top: 0; left: 0; right: 0;
      height: 3px;
      background: var(--gradient-primary);
      opacity: 0;
      transition: opacity 0.2s;
    }
    .bank-card:hover {
      border-color: rgba(99,102,241,0.2);
      transform: translateY(-2px);
      box-shadow: var(--shadow-3d-hover);
    }
    .bank-card:hover::before { opacity: 1; }
    .bank-card-body { padding: 24px 24px 16px; }
    .bank-icon {
      width: 44px; height: 44px;
      border-radius: 12px;
      background: var(--gradient-primary-subtle);
      display: flex; align-items: center; justify-content: center;
      margin-bottom: 16px;
      color: var(--primary);
    }
    .bank-icon svg { width: 22px; height: 22px; }
    .bank-name { font-size: 17px; font-weight: 700; color: var(--white); margin-bottom: 4px; }
    .bank-subject {
      font-size: 13px; color: var(--gray-400);
      display: flex; align-items: center; gap: 6px;
    }
    .bank-desc {
      font-size: 13px; color: var(--gray-500);
      margin-top: 8px;
      display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden;
      line-clamp: 2;
    }
    .bank-footer {
      display: flex; align-items: center; justify-content: space-between;
      padding: 14px 24px;
      background: #f9fafb;
      border-top: 1px solid #f3f4f6;
    }
    .bank-stat-row { display: flex; gap: 20px; }
    .bank-stat-item { text-align: center; }
    .bank-stat-num {
      font-size: 20px; font-weight: 800;
      background: var(--gradient-primary);
      -webkit-background-clip: text; -webkit-text-fill-color: transparent;
      background-clip: text;
    }
    .bank-stat-lbl { font-size: 11px; color: var(--gray-500); text-transform: uppercase; letter-spacing: 0.5px; font-weight: 600; }
    .bank-actions-row { display: flex; gap: 6px; }
    .bank-actions-row .icon-btn {
      width: 34px; height: 34px; border-radius: 8px;
      display: flex; align-items: center; justify-content: center;
      background: #f3f4f6; border: 1px solid #e5e7eb;
      cursor: pointer; color: var(--gray-400); transition: all 0.15s;
    }
    .bank-actions-row .icon-btn:hover { background: var(--primary-light); color: var(--primary); border-color: rgba(99,102,241,0.2); }
    .bank-actions-row .icon-btn.danger:hover { background: var(--danger-light); color: var(--danger); border-color: rgba(220,38,38,0.2); }
    .bank-actions-row .icon-btn svg { width: 15px; height: 15px; }

    /* ===== Questions Slide Panel ===== */
    .q-panel-overlay {
      position: fixed; inset: 0;
      background: rgba(0,0,0,0.35);
      z-index: 1000;
      display: none; opacity: 0;
      transition: opacity 0.25s;
    }
    .q-panel-overlay.active { display: block; opacity: 1; }
    .q-panel {
      position: fixed; top: 0; right: -720px; bottom: 0;
      width: min(720px, 100vw);
      background: var(--bg-surface);
      border-left: 1px solid #e5e7eb;
      z-index: 1001;
      display: flex; flex-direction: column;
      transition: right 0.35s cubic-bezier(0.4, 0, 0.2, 1);
      box-shadow: -4px 0 24px rgba(0,0,0,0.08);
    }
    .q-panel.open { right: 0; }
    .q-panel-header {
      display: flex; align-items: center; justify-content: space-between;
      padding: 20px 24px;
      border-bottom: 1px solid #f3f4f6;
      flex-shrink: 0;
    }
    .q-panel-title { font-size: 18px; font-weight: 700; color: var(--white); }
    .q-panel-subtitle { font-size: 13px; color: var(--gray-400); margin-top: 2px; }
    .q-panel-toolbar {
      display: flex; align-items: center; gap: 10px;
      padding: 14px 24px;
      background: #f9fafb;
      border-bottom: 1px solid #f3f4f6;
      flex-shrink: 0;
    }
    .q-search {
      flex: 1; padding: 8px 14px; font-size: 13px;
      background: #ffffff; border: 1px solid #d1d5db;
      border-radius: 8px; color: var(--text-color); outline: none;
      transition: border-color 0.15s;
      font-family: var(--font);
    }
    .q-search:focus { border-color: rgba(99,102,241,0.3); }
    .q-search::placeholder { color: var(--gray-500); }
    .q-filter-select {
      padding: 8px 12px; font-size: 12px;
      background: #ffffff; border: 1px solid #d1d5db;
      border-radius: 8px; color: #374151; cursor: pointer; outline: none;
      font-family: var(--font);
    }
    .q-panel-body {
      flex: 1; overflow-y: auto; padding: 16px 24px;
    }
    .q-panel-body::-webkit-scrollbar { width: 6px; }
    .q-panel-body::-webkit-scrollbar-track { background: transparent; }
    .q-panel-body::-webkit-scrollbar-thumb { background: rgba(0,0,0,0.1); border-radius: 3px; }
    .q-panel-empty {
      text-align: center; padding: 60px 20px;
      color: var(--gray-500);
    }
    .q-panel-empty svg { width: 48px; height: 48px; color: var(--gray-600); margin-bottom: 12px; }
    .q-panel-empty h3 { color: var(--gray-300); font-size: 16px; margin-bottom: 6px; }

    /* ===== Question Cards ===== */
    .q-card {
      background: #ffffff;
      border: 1px solid #f3f4f6;
      border-radius: 12px;
      margin-bottom: 12px;
      transition: border-color 0.15s, background 0.15s;
      overflow: hidden;
    }
    .q-card:hover { border-color: var(--primary); background: rgba(79,70,229,0.02); }
    .q-card-head {
      display: flex; align-items: flex-start; gap: 12px;
      padding: 16px 18px 12px;
    }
    .q-badge {
      width: 30px; height: 30px; border-radius: 8px;
      background: var(--gradient-primary);
      color: var(--bg-deepest);
      display: flex; align-items: center; justify-content: center;
      font-size: 12px; font-weight: 800;
      flex-shrink: 0;
    }
    .q-card-info { flex: 1; min-width: 0; }
    .q-card-text {
      font-size: 14px; font-weight: 500; color: var(--gray-100);
      line-height: 1.5;
      word-wrap: break-word;
    }
    .q-card-meta {
      display: flex; align-items: center; gap: 8px;
      margin-top: 8px; flex-wrap: wrap;
    }
    .q-tag {
      font-size: 11px; font-weight: 600; padding: 2px 8px;
      border-radius: 6px; text-transform: uppercase; letter-spacing: 0.3px;
    }
    .q-tag.easy { background: rgba(0,230,118,0.1); color: #00e676; }
    .q-tag.medium { background: rgba(255,171,0,0.1); color: #ffab00; }
    .q-tag.hard { background: rgba(220,38,38,0.1); color: #dc2626; }
    .q-tag.marks { background: rgba(99,102,241,0.08); color: var(--primary); }
    .q-tag.type { background: rgba(167,139,250,0.1); color: var(--accent); }
    .q-card-actions {
      display: flex; gap: 4px; flex-shrink: 0;
    }
    .q-card-actions button {
      width: 32px; height: 32px; border-radius: 8px;
      display: flex; align-items: center; justify-content: center;
      background: transparent; border: 1px solid transparent;
      cursor: pointer; color: var(--gray-500); transition: all 0.15s;
    }
    .q-card-actions button:hover { background: rgba(255,255,255,0.06); color: var(--primary); border-color: rgba(255,255,255,0.08); }
    .q-card-actions button.danger:hover { color: var(--danger); }
    .q-card-actions button svg { width: 14px; height: 14px; }

    /* Options Grid */
    .q-opts {
      display: grid; grid-template-columns: 1fr 1fr;
      gap: 6px;
      padding: 0 18px 14px;
      margin-left: 42px;
    }
    .q-opt {
      display: flex; align-items: center; gap: 8px;
      padding: 8px 12px;
      background: #f9fafb;
      border: 1px solid #f3f4f6;
      border-radius: 8px;
      font-size: 13px; color: #4b5563;
      transition: all 0.15s;
    }
    .q-opt-letter {
      width: 22px; height: 22px; border-radius: 6px;
      display: flex; align-items: center; justify-content: center;
      font-size: 11px; font-weight: 700;
      background: #e5e7eb; color: #6b7280;
      flex-shrink: 0;
    }
    .q-opt.correct {
      background: rgba(0,230,118,0.06);
      border-color: rgba(0,230,118,0.2);
      color: var(--success);
    }
    .q-opt.correct .q-opt-letter {
      background: var(--success);
      color: var(--bg-deepest);
    }
    .q-opt-text { overflow: hidden; text-overflow: ellipsis; }

    /* ===== Dark theme overrides ===== */
    body.dark .bank-card { background: var(--glass-bg-solid); border-color: rgba(255,255,255,0.06); }
    body.dark .bank-card:hover { border-color: rgba(99,102,241,0.2); box-shadow: var(--shadow-3d-hover); }
    body.dark .bank-name { color: var(--white); }
    body.dark .bank-subject { color: var(--gray-400); }
    body.dark .bank-desc { color: var(--gray-500); }
    body.dark .bank-footer { background: rgba(0,0,0,0.15); border-top-color: rgba(255,255,255,0.04); }
    body.dark .bank-actions-row .icon-btn { background: rgba(255,255,255,0.04); border-color: rgba(255,255,255,0.06); color: var(--gray-400); }
    body.dark .q-panel { border-left-color: rgba(99,102,241,0.08); box-shadow: -8px 0 40px rgba(0,0,0,0.5); }
    body.dark .q-panel-header { border-bottom-color: rgba(255,255,255,0.06); }
    body.dark .q-panel-title { color: var(--white); }
    body.dark .q-panel-subtitle { color: var(--gray-400); }
    body.dark .q-panel-toolbar { background: rgba(0,0,0,0.1); border-bottom-color: rgba(255,255,255,0.04); }
    body.dark .q-search { background: rgba(255,255,255,0.04); border-color: rgba(255,255,255,0.08); color: var(--white); }
    body.dark .q-search::placeholder { color: var(--gray-500); }
    body.dark .q-filter-select { background: rgba(255,255,255,0.04); border-color: rgba(255,255,255,0.08); color: var(--gray-300); }
    body.dark .q-card { background: rgba(255,255,255,0.02); border-color: rgba(255,255,255,0.05); }
    body.dark .q-card:hover { border-color: rgba(99,102,241,0.12); background: rgba(99,102,241,0.02); }
    body.dark .q-card-text { color: var(--gray-100); }
    body.dark .q-opt { background: rgba(255,255,255,0.02); border-color: rgba(255,255,255,0.04); color: var(--gray-400); }
    body.dark .q-opt-letter { background: rgba(255,255,255,0.06); color: var(--gray-400); }
    body.dark .q-opt.correct { background: rgba(0,230,118,0.06); border-color: rgba(0,230,118,0.2); }
    body.dark .q-opt.correct .q-opt-letter { background: var(--success); color: var(--bg-deepest); }
    body.dark .q-panel-overlay { background: rgba(3,7,18,0.85); }
    body.dark .q-badge { color: var(--bg-deepest); }
    body.dark .q-panel-body::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.08); }

    /* ===== Responsive ===== */
    @media (max-width: 768px) {
      .q-panel { width: 100vw; right: -100vw; }
      .q-opts { grid-template-columns: 1fr; margin-left: 0; }
      .bank-grid { grid-template-columns: 1fr; }
      .q-panel-header { flex-wrap: wrap; gap: 10px; }
    }
  </style>
</head>
<body>
  <div class="layout">
    <main class="main">
      <div class="page-header flex items-center justify-between">
        <div>
          <h1 class="page-title">Question Banks</h1>
          <p class="page-subtitle">Manage your question collections</p>
        </div>
        <button class="btn btn-primary" onclick="openBankModal()">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width:18px;height:18px;"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
          New Bank
        </button>
      </div>

      <div class="bank-grid" id="banks-grid">
        <div class="loading"><div class="spinner"></div></div>
      </div>
    </main>
  </div>

  <!-- ===== Bank Create/Edit Modal ===== -->
  <div class="modal-overlay" id="bank-modal">
    <div class="modal">
      <div class="modal-header">
        <h3 class="modal-title" id="bank-modal-title">Create Question Bank</h3>
        <button class="modal-close" onclick="closeBankModal()">&times;</button>
      </div>
      <form id="bank-form">
        <div class="modal-body">
          <input type="hidden" id="bank-id">
          <div class="form-group">
            <label class="form-label">Name *</label>
            <input type="text" class="form-input" id="bank-name" required placeholder="e.g., Mathematics Grade 10">
          </div>
          <div class="form-group">
            <label class="form-label">Subject *</label>
            <input type="text" class="form-input" id="bank-subject" required placeholder="e.g., Mathematics">
          </div>
          <div class="form-group">
            <label class="form-label">Description</label>
            <textarea class="form-input" id="bank-desc" rows="2" placeholder="Optional description"></textarea>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" onclick="closeBankModal()">Cancel</button>
          <button type="submit" class="btn btn-primary">Save</button>
        </div>
      </form>
    </div>
  </div>

  <!-- ===== Question Add/Edit Modal ===== -->
  <div class="modal-overlay" id="q-modal">
    <div class="modal" style="max-width:680px;">
      <div class="modal-header">
        <h3 class="modal-title" id="q-modal-title">Add Question</h3>
        <button class="modal-close" onclick="closeQModal()">&times;</button>
      </div>
      <form id="q-form">
        <div class="modal-body">
          <input type="hidden" id="q-id">
          <input type="hidden" id="q-bank-id">
          <div id="q-session-counter" style="display:none;margin-bottom:14px;padding:10px 16px;background:rgba(99,102,241,0.06);border:1px solid rgba(99,102,241,0.12);border-radius:10px;color:var(--primary);font-size:13px;font-weight:600;align-items:center;gap:8px;">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width:16px;height:16px;flex-shrink:0;"><polyline points="20 6 9 17 4 12"/></svg>
            <span id="q-session-text"></span>
          </div>
          <div class="form-group">
            <label class="form-label">Question Text *</label>
            <textarea class="form-input" id="q-text" rows="3" required placeholder="Enter the question"></textarea>
          </div>
          <div class="grid grid-2">
            <div class="form-group">
              <label class="form-label">Option A *</label>
              <input type="text" class="form-input" id="q-opt-a" required placeholder="First option">
            </div>
            <div class="form-group">
              <label class="form-label">Option B *</label>
              <input type="text" class="form-input" id="q-opt-b" required placeholder="Second option">
            </div>
            <div class="form-group">
              <label class="form-label">Option C</label>
              <input type="text" class="form-input" id="q-opt-c" placeholder="Third option (optional)">
            </div>
            <div class="form-group">
              <label class="form-label">Option D</label>
              <input type="text" class="form-input" id="q-opt-d" placeholder="Fourth option (optional)">
            </div>
          </div>
          <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:16px;">
            <div class="form-group">
              <label class="form-label">Correct Answer *</label>
              <select class="form-select" id="q-correct" required>
                <option value="A">A</option>
                <option value="B">B</option>
                <option value="C">C</option>
                <option value="D">D</option>
              </select>
            </div>
            <div class="form-group">
              <label class="form-label">Difficulty</label>
              <select class="form-select" id="q-difficulty">
                <option value="EASY">Easy</option>
                <option value="MEDIUM" selected>Medium</option>
                <option value="HARD">Hard</option>
              </select>
            </div>
            <div class="form-group">
              <label class="form-label">Marks</label>
              <input type="number" class="form-input" id="q-marks" value="1" min="0.5" step="0.5">
            </div>
          </div>
        </div>
        <div class="modal-footer" style="display:flex;gap:8px;justify-content:flex-end;">
          <button type="button" class="btn btn-secondary" onclick="closeQModal()">Cancel</button>
          <button type="button" class="btn btn-primary" id="save-and-add-btn" style="background:linear-gradient(135deg,#a78bfa,#7c3aed);" onclick="saveAndAddAnother()">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width:15px;height:15px;"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
            Save &amp; Add Another
          </button>
          <button type="submit" class="btn btn-primary" id="save-q-btn">Save &amp; Close</button>
        </div>
      </form>
    </div>
  </div>

  <!-- ===== Bulk Add Modal ===== -->
  <div class="modal-overlay" id="bulk-modal">
    <div class="modal" style="max-width:700px;">
      <form id="bulk-form">
        <div class="modal-header">
          <h3 class="modal-title">Bulk Add Questions</h3>
          <button type="button" class="modal-close" onclick="closeBulkModal()">&times;</button>
        </div>
        <div class="modal-body">
          <input type="hidden" id="bulk-bank-id">
          <div class="form-group">
            <label class="form-label">Enter questions (one per line)</label>
            <p class="text-sm text-gray mb-2">Format: <code style="background:rgba(255,255,255,0.06);padding:2px 6px;border-radius:4px;font-size:12px;">Question | A | B | C | D | Correct | Marks | Difficulty</code></p>
            <textarea class="form-input" id="bulk-questions" rows="10" placeholder="What is 2+2? | 3 | 4 | 5 | 6 | B | 1 | EASY
What is the capital of France? | London | Paris | Berlin | Rome | B | 1 | MEDIUM"></textarea>
          </div>
          <div class="text-sm text-gray" style="background:rgba(255,255,255,0.02);padding:12px 16px;border-radius:8px;border:1px solid rgba(255,255,255,0.04);">
            <strong>Tips:</strong>
            <ul style="margin-left:20px;margin-top:4px;line-height:1.8;">
              <li>Use pipe <code style="background:rgba(255,255,255,0.06);padding:1px 4px;border-radius:3px;">|</code> to separate fields</li>
              <li>For True/False questions, only fill Option A &amp; B</li>
              <li>Difficulty: EASY, MEDIUM, or HARD</li>
              <li>Marks is optional (default: 1)</li>
            </ul>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" onclick="closeBulkModal()">Cancel</button>
          <button type="submit" class="btn btn-primary">Add All Questions</button>
        </div>
      </form>
    </div>
  </div>

  <!-- ===== Questions Slide Panel ===== -->
  <div class="q-panel-overlay" id="q-panel-overlay" onclick="closeQPanel()"></div>
  <div class="q-panel" id="q-panel">
    <div class="q-panel-header">
      <div>
        <div class="q-panel-title" id="panel-title">Questions</div>
        <div class="q-panel-subtitle" id="panel-subtitle">0 questions</div>
      </div>
      <div style="display:flex;gap:8px;align-items:center;">
        <button class="btn btn-sm btn-secondary" id="panel-bulk-btn" style="font-size:12px;">+ Bulk</button>
        <button class="btn btn-sm btn-primary" id="panel-add-btn" style="font-size:12px;">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width:14px;height:14px;"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
          Add
        </button>
        <button class="modal-close" onclick="closeQPanel()" style="margin-left:4px;">&times;</button>
      </div>
    </div>
    <div class="q-panel-toolbar">
      <input type="text" class="q-search" id="q-search" placeholder="Search questions..." oninput="filterQuestions()">
      <select class="q-filter-select" id="q-diff-filter" onchange="filterQuestions()">
        <option value="">All Levels</option>
        <option value="EASY">Easy</option>
        <option value="MEDIUM">Medium</option>
        <option value="HARD">Hard</option>
      </select>
    </div>
    <div class="q-panel-body" id="q-panel-body">
      <div class="loading"><div class="spinner"></div></div>
    </div>
  </div>

  <script src="/js/app.js"></script>
  <script>
    if (!initPage('questions', ['admin'])) throw new Error('Auth required');

    let banks = [];
    let currentBankId = null;
    let currentQuestions = [];
    let sessionAddedCount = 0;

    // ===== Bank CRUD =====
    async function loadBanks() {
      const grid = document.getElementById('banks-grid');
      grid.innerHTML = '<div class="loading" style="grid-column:1/-1;"><div class="spinner"></div></div>';
      try {
        const data = await http.get('/question-banks?active_only=false', false);
        banks = Array.isArray(data) ? data : [];
        renderBanks();
      } catch (err) {
        banks = [];
        grid.innerHTML = '<div class="empty" style="grid-column:1/-1;"><div class="empty-title">Failed to load question banks</div><p class="text-sm text-gray">Please refresh the page</p></div>';
        UI.toast('Failed to load question banks', 'error');
      }
    }

    function renderBanks() {
      const grid = document.getElementById('banks-grid');
      if (!banks.length) {
        grid.innerHTML = `
          <div class="empty" style="grid-column:1/-1;padding:60px 20px;">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" style="width:48px;height:48px;color:var(--gray-600);margin-bottom:12px;">
              <circle cx="12" cy="12" r="10"/><path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"/><path d="M12 17h.01"/>
            </svg>
            <div class="empty-title">No question banks yet</div>
            <p class="text-sm text-gray">Create your first question bank to get started</p>
          </div>`;
        return;
      }

      grid.innerHTML = banks.map(b => `
        <div class="bank-card" onclick="viewBank(${b.id})">
          <div class="bank-card-body">
            <div class="bank-icon">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"/><path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"/>
              </svg>
            </div>
            <div class="bank-name">${b.name}</div>
            <div class="bank-subject">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width:13px;height:13px;"><path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z"/><path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z"/></svg>
              ${b.subject || 'General'}
            </div>
            ${b.description ? `<div class="bank-desc">${b.description}</div>` : ''}
          </div>
          <div class="bank-footer" onclick="event.stopPropagation()">
            <div class="bank-stat-row">
              <div class="bank-stat-item">
                <div class="bank-stat-num">${b.question_count || 0}</div>
                <div class="bank-stat-lbl">Questions</div>
              </div>
            </div>
            <div class="bank-actions-row">
              <button class="icon-btn" onclick="editBank(${b.id})" title="Edit Bank">
                ${Icons.edit}
              </button>
              <button class="icon-btn danger" onclick="deleteBank(${b.id})" title="Delete Bank">
                ${Icons.trash}
              </button>
            </div>
          </div>
        </div>
      `).join('');
    }

    function openBankModal(bank = null) {
      document.getElementById('bank-modal-title').textContent = bank ? 'Edit Bank' : 'Create Bank';
      document.getElementById('bank-form').reset();
      document.getElementById('bank-id').value = bank?.id || '';
      if (bank) {
        document.getElementById('bank-name').value = bank.name;
        document.getElementById('bank-subject').value = bank.subject || '';
        document.getElementById('bank-desc').value = bank.description || '';
      }
      document.getElementById('bank-modal').classList.add('active');
    }

    function closeBankModal() { document.getElementById('bank-modal').classList.remove('active'); }

    function editBank(id) {
      const bank = banks.find(b => b.id === id);
      if (bank) openBankModal(bank);
    }

    async function deleteBank(id) {
      if (!confirm('Delete this bank and ALL its questions? This cannot be undone.')) return;
      try {
        await http.delete(`/question-banks/${id}`);
        UI.toast('Bank deleted');
        http.clearCache();
        loadBanks();
      } catch (err) { UI.toast(err.message, 'error'); }
    }

    document.getElementById('bank-form').addEventListener('submit', async (e) => {
      e.preventDefault();
      const form = e.target;
      const submitBtn = form.querySelector('button[type="submit"]');
      UI.clearErrors(form);
      UI.btnLoading(submitBtn, true);

      const id = document.getElementById('bank-id').value;
      const data = {
        name: document.getElementById('bank-name').value.trim(),
        subject: document.getElementById('bank-subject').value.trim(),
        description: document.getElementById('bank-desc').value.trim() || null
      };

      try {
        if (id) {
          await http.patch(`/question-banks/${id}`, data);
          UI.toast('Bank updated');
        } else {
          await http.post('/question-banks', data);
          UI.toast('Bank created');
        }
        closeBankModal();
        http.clearCache();
        loadBanks();
      } catch (err) {
        err.errors?.length ? UI.showErrors(form, err.errors) : UI.toast(err.message, 'error');
      } finally { UI.btnLoading(submitBtn, false); }
    });

    // ===== Question Panel (slide-out) =====
    async function viewBank(id) {
      currentBankId = id;
      const bank = banks.find(b => b.id === id);
      document.getElementById('panel-title').textContent = bank?.name || 'Questions';
      document.getElementById('panel-add-btn').onclick = () => openQModal(id);
      document.getElementById('panel-bulk-btn').onclick = () => openBulkModal(id);
      document.getElementById('q-search').value = '';
      document.getElementById('q-diff-filter').value = '';
      document.getElementById('q-panel-body').innerHTML = '<div class="loading"><div class="spinner"></div></div>';

      // Open panel with animation
      document.getElementById('q-panel-overlay').classList.add('active');
      requestAnimationFrame(() => document.getElementById('q-panel').classList.add('open'));

      try {
        currentQuestions = await http.get(`/question-banks/${id}/questions`, false);
        document.getElementById('panel-subtitle').textContent = `${currentQuestions.length} question${currentQuestions.length !== 1 ? 's' : ''}`;
        renderQuestions(currentQuestions);
      } catch (err) {
        document.getElementById('q-panel-body').innerHTML = '<div class="q-panel-empty"><h3>Failed to load questions</h3><p class="text-sm">Please try again</p></div>';
      }
    }

    function closeQPanel() {
      document.getElementById('q-panel').classList.remove('open');
      setTimeout(() => document.getElementById('q-panel-overlay').classList.remove('active'), 350);
    }

    function filterQuestions() {
      const search = document.getElementById('q-search').value.toLowerCase();
      const diff = document.getElementById('q-diff-filter').value;
      let filtered = currentQuestions;
      if (search) filtered = filtered.filter(q => q.question_text.toLowerCase().includes(search));
      if (diff) filtered = filtered.filter(q => q.difficulty === diff);
      renderQuestions(filtered);
    }

    function renderQuestions(questions) {
      const body = document.getElementById('q-panel-body');
      if (!questions.length) {
        body.innerHTML = `
          <div class="q-panel-empty">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
              <circle cx="11" cy="11" r="8"/><path d="M21 21l-4.35-4.35"/>
            </svg>
            <h3>No questions found</h3>
            <p class="text-sm" style="color:var(--gray-500);">Add your first question or adjust filters</p>
          </div>`;
        return;
      }

      body.innerHTML = questions.map((q, i) => {
        const opts = Array.isArray(q.options) ? q.options : ['A','B','C','D'].map(k => q.options?.[k] || '');
        const diffClass = (q.difficulty || 'MEDIUM').toLowerCase();
        const diffLabel = (q.difficulty || 'MEDIUM').charAt(0) + (q.difficulty || 'MEDIUM').slice(1).toLowerCase();
        return `
        <div class="q-card">
          <div class="q-card-head">
            <div class="q-badge">${i + 1}</div>
            <div class="q-card-info">
              <div class="q-card-text">${q.question_text}</div>
              <div class="q-card-meta">
                <span class="q-tag ${diffClass}">${diffLabel}</span>
                <span class="q-tag marks">${q.marks || 1} mark${(q.marks || 1) !== 1 ? 's' : ''}</span>
                <span class="q-tag type">${(q.question_type || 'MCQ').replace('_',' ')}</span>
              </div>
            </div>
            <div class="q-card-actions">
              <button onclick="editQuestion(${q.id})" title="Edit Question">
                ${Icons.edit}
              </button>
              <button class="danger" onclick="deleteQuestion(${q.id})" title="Delete Question">
                ${Icons.trash}
              </button>
            </div>
          </div>
          <div class="q-opts">
            ${opts.map((opt, j) => {
              if (!opt) return '';
              const letter = ['A','B','C','D'][j];
              const isCorrect = q.correct_answer === letter;
              return `
              <div class="q-opt ${isCorrect ? 'correct' : ''}">
                <span class="q-opt-letter">${letter}</span>
                <span class="q-opt-text">${opt}</span>
              </div>`;
            }).join('')}
          </div>
        </div>`;
      }).join('');
    }

    // ===== Question CRUD =====
    function openQModal(bankId, question = null) {
      document.getElementById('q-modal-title').textContent = question ? 'Edit Question' : 'Add Question';
      document.getElementById('save-q-btn').textContent = question ? 'Update Question' : 'Save & Close';
      document.getElementById('q-form').reset();
      document.getElementById('q-id').value = question?.id || '';
      document.getElementById('q-bank-id').value = bankId;

      const addAnotherBtn = document.getElementById('save-and-add-btn');
      addAnotherBtn.style.display = question ? 'none' : '';

      if (!question) updateSessionCounter();
      else document.getElementById('q-session-counter').style.display = 'none';

      if (question) {
        document.getElementById('q-text').value = question.question_text;
        const opts = question.options || {};
        if (Array.isArray(opts)) {
          document.getElementById('q-opt-a').value = opts[0] || '';
          document.getElementById('q-opt-b').value = opts[1] || '';
          document.getElementById('q-opt-c').value = opts[2] || '';
          document.getElementById('q-opt-d').value = opts[3] || '';
        } else {
          document.getElementById('q-opt-a').value = opts['A'] || opts['a'] || '';
          document.getElementById('q-opt-b').value = opts['B'] || opts['b'] || '';
          document.getElementById('q-opt-c').value = opts['C'] || opts['c'] || '';
          document.getElementById('q-opt-d').value = opts['D'] || opts['d'] || '';
        }
        document.getElementById('q-correct').value = question.correct_answer || 'A';
        document.getElementById('q-difficulty').value = question.difficulty || 'MEDIUM';
        document.getElementById('q-marks').value = question.marks || 1;
      }

      document.getElementById('q-modal').classList.add('active');
    }

    function updateSessionCounter() {
      const counter = document.getElementById('q-session-counter');
      if (sessionAddedCount > 0) {
        counter.style.display = 'flex';
        document.getElementById('q-session-text').textContent = `${sessionAddedCount} question${sessionAddedCount > 1 ? 's' : ''} added in this session`;
      } else {
        counter.style.display = 'none';
      }
    }

    function closeQModal() {
      document.getElementById('q-modal').classList.remove('active');
      if (sessionAddedCount > 0) {
        http.clearCache();
        if (currentBankId) viewBank(currentBankId);
        loadBanks();
        sessionAddedCount = 0;
      }
    }

    function getQuestionFormData() {
      const bankId = document.getElementById('q-bank-id').value;
      const options = {
        A: document.getElementById('q-opt-a').value.trim(),
        B: document.getElementById('q-opt-b').value.trim(),
        C: document.getElementById('q-opt-c').value.trim(),
        D: document.getElementById('q-opt-d').value.trim()
      };
      Object.keys(options).forEach(k => { if (!options[k]) delete options[k]; });

      return {
        bankId,
        data: {
          question_bank_id: parseInt(bankId),
          question_text: document.getElementById('q-text').value.trim(),
          question_type: 'MCQ',
          options,
          correct_answer: document.getElementById('q-correct').value,
          difficulty: document.getElementById('q-difficulty').value,
          marks: parseFloat(document.getElementById('q-marks').value) || 1,
          negative_marks: 0
        }
      };
    }

    async function saveAndAddAnother() {
      const form = document.getElementById('q-form');
      if (!form.reportValidity()) return;

      const btn = document.getElementById('save-and-add-btn');
      UI.clearErrors(form);
      UI.btnLoading(btn, true);

      const { bankId, data } = getQuestionFormData();
      try {
        await http.post(`/question-banks/${bankId}/questions`, data);
        sessionAddedCount++;
        updateSessionCounter();
        UI.toast(`Question ${sessionAddedCount} added!`, 'success');

        const savedBankId = document.getElementById('q-bank-id').value;
        const savedDifficulty = document.getElementById('q-difficulty').value;
        const savedMarks = document.getElementById('q-marks').value;
        document.getElementById('q-form').reset();
        document.getElementById('q-bank-id').value = savedBankId;
        document.getElementById('q-difficulty').value = savedDifficulty;
        document.getElementById('q-marks').value = savedMarks;
        document.getElementById('q-id').value = '';
        document.getElementById('q-text').focus();
      } catch (err) {
        err.errors?.length ? UI.showErrors(form, err.errors) : UI.toast(err.message, 'error');
      } finally { UI.btnLoading(btn, false); }
    }

    async function editQuestion(id) {
      if (!id) { UI.toast('Invalid question ID', 'error'); return; }
      try {
        const q = await http.get(`/questions/${id}`, false);
        if (!q || !q.id) { UI.toast('Question not found', 'error'); return; }
        openQModal(currentBankId, q);
      } catch (err) {
        UI.toast('Failed to load question: ' + (err.message || 'Unknown error'), 'error');
      }
    }

    async function deleteQuestion(id) {
      if (!confirm('Delete this question?')) return;
      try {
        await http.delete(`/questions/${id}`);
        UI.toast('Question deleted');
        http.clearCache();
        viewBank(currentBankId);
        loadBanks();
      } catch (err) { UI.toast(err.message, 'error'); }
    }

    document.getElementById('q-form').addEventListener('submit', async (e) => {
      e.preventDefault();
      const form = e.target;
      const submitBtn = document.getElementById('save-q-btn');
      UI.clearErrors(form);
      UI.btnLoading(submitBtn, true);

      const id = document.getElementById('q-id').value;
      const { bankId, data } = getQuestionFormData();

      try {
        if (id) {
          await http.patch(`/questions/${id}`, data);
          UI.toast('Question updated');
        } else {
          await http.post(`/question-banks/${bankId}/questions`, data);
          sessionAddedCount++;
          UI.toast('Question added');
        }
        document.getElementById('q-modal').classList.remove('active');
        sessionAddedCount = 0;
        http.clearCache();
        viewBank(currentBankId);
        loadBanks();
      } catch (err) {
        err.errors?.length ? UI.showErrors(form, err.errors) : UI.toast(err.message, 'error');
      } finally { UI.btnLoading(submitBtn, false); }
    });

    // ===== Bulk Add =====
    function openBulkModal(bankId) {
      document.getElementById('bulk-form').reset();
      document.getElementById('bulk-bank-id').value = bankId;
      document.getElementById('bulk-modal').classList.add('active');
    }

    function closeBulkModal() { document.getElementById('bulk-modal').classList.remove('active'); }

    function parseBulkQuestions(text) {
      const lines = text.trim().split('\n').filter(l => l.trim());
      return lines.map(line => {
        const parts = line.split('|').map(p => p.trim());
        if (parts.length < 6) return null;
        const [question, optA, optB, optC, optD, correct, marks, difficulty] = parts;
        return {
          question_text: question,
          question_type: (!optC && !optD) ? 'TRUE_FALSE' : 'MCQ',
          options: { A: optA, B: optB, C: optC || '', D: optD || '' },
          correct_answer: (correct || 'A').toUpperCase(),
          marks: parseFloat(marks) || 1,
          difficulty: (difficulty || 'MEDIUM').toUpperCase(),
          negative_marks: 0
        };
      }).filter(Boolean);
    }

    document.getElementById('bulk-form').addEventListener('submit', async (e) => {
      e.preventDefault();
      const form = e.target;
      const submitBtn = form.querySelector('button[type="submit"]');
      const bankId = document.getElementById('bulk-bank-id').value;
      const bulkText = document.getElementById('bulk-questions').value;
      UI.btnLoading(submitBtn, true);

      try {
        const questions = parseBulkQuestions(bulkText);
        if (!questions.length) { UI.toast('No valid questions found. Check format.', 'error'); return; }

        let ok = 0, fail = 0;
        for (const q of questions) {
          try { await http.post(`/question-banks/${bankId}/questions`, q); ok++; }
          catch { fail++; }
        }

        UI.toast(ok ? `Added ${ok} question${ok > 1 ? 's' : ''}${fail ? `, ${fail} failed` : ''}` : 'All questions failed to add', ok ? 'success' : 'error');
        closeBulkModal();
        http.clearCache();
        viewBank(currentBankId);
        loadBanks();
      } catch (err) { UI.toast(err.message, 'error'); }
      finally { UI.btnLoading(submitBtn, false); }
    });

    // ===== Keyboard shortcuts =====
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape') {
        if (document.getElementById('q-modal').classList.contains('active')) closeQModal();
        else if (document.getElementById('bulk-modal').classList.contains('active')) closeBulkModal();
        else if (document.getElementById('bank-modal').classList.contains('active')) closeBankModal();
        else if (document.getElementById('q-panel').classList.contains('open')) closeQPanel();
      }
    });

    loadBanks();
  </script>
</body>
</html>
